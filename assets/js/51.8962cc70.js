(window.webpackJsonp=window.webpackJsonp||[]).push([[51],{405:function(s,e,n){"use strict";n.r(e);var a=n(42),t=Object(a.a)({},(function(){var s=this,e=s.$createElement,n=s._self._c||e;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("h1",{attrs:{id:"deployment控制器"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#deployment控制器"}},[s._v("#")]),s._v(" Deployment控制器")]),s._v(" "),n("hr"),s._v(" "),n("h2",{attrs:{id:"pod与controllers的关系"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#pod与controllers的关系"}},[s._v("#")]),s._v(" Pod与controllers的关系")]),s._v(" "),n("p",[s._v("• controllers：在集群上管理和运行容器的对象"),n("br"),s._v("\n• 通过label-selector相关联(pod模板文件中有配置相关参数)"),n("br"),s._v("\n• Pod通过控制器实现应用的运维，如伸缩，滚动升级等"),n("br"),s._v(" "),n("img",{attrs:{src:"/images/k8s/k8s9.png",alt:""}}),n("br"),s._v("\n控制器的另一个名称：工作负载(workload)")]),s._v(" "),n("h2",{attrs:{id:"deployment功能与应用场景"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#deployment功能与应用场景"}},[s._v("#")]),s._v(" Deployment功能与应用场景")]),s._v(" "),n("p",[s._v("• 部署无状态应用"),n("br"),s._v("\n• 管理Pod和ReplicaSet(也是一个控制器)"),n("br"),s._v("\n• 具有上线部署、副本设定、滚动升级、回滚等功能"),n("br"),s._v("\n• 提供申明式更新，例如只更新一个新的Image"),n("br"),s._v("\n应用场景：Web服务，微服务"),n("br")]),s._v(" "),n("h2",{attrs:{id:"yaml字段解析"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#yaml字段解析"}},[s._v("#")]),s._v(" YAML字段解析")]),s._v(" "),n("p",[n("img",{attrs:{src:"/images/k8s/k8s10.png",alt:""}}),n("br")]),s._v(" "),n("h2",{attrs:{id:"使用deployment部署一个应用"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#使用deployment部署一个应用"}},[s._v("#")]),s._v(" 使用Deployment部署一个应用")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("# 记住下面这个就可以了，根据提示写\n$ kubectl create deployment --help\n\n# 生成一个标准的yaml模板\n[root@k8s-master ~]# kubectl create deployment web --image=nginx --dry-run -o yaml > web.yaml\n\n# 然后可以编辑这个模板，配置我们真正想要的镜像，副本数啊，资源限制...等等参数\n#################################################################\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  labels:\n    app: web\n  name: web\nspec:\n  replicas: 3\n  selector:\n    matchLabels:\n      app: web\n  template:\n    metadata:\n      labels:\n        app: web\n    spec:\n      containers:\n      - image: david0607/java-demo\n        name: java\n#################################################################\n# 执行\n$ kubectl apply -f web.yaml\n\n$ kubectl get pods\nweb-7dd67f8b9c-rvh7q         1/1     Running   0          7m3s\nweb-7dd67f8b9c-swvfc         1/1     Running   0          7m3s\nweb-7dd67f8b9c-zdc9n         1/1     Running   0          7m3s\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br")])]),n("h2",{attrs:{id:"升级与回滚"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#升级与回滚"}},[s._v("#")]),s._v(" 升级与回滚")]),s._v(" "),n("h3",{attrs:{id:"_1-创建"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-创建"}},[s._v("#")]),s._v(" 1.创建")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("# 命令行部署不利于维护，一般输出yaml\nkubectl create deployment web --image=nginx:1.14\nkubectl get deploy,pods\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])]),n("h3",{attrs:{id:"_2-发布"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-发布"}},[s._v("#")]),s._v(" 2.发布")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("# service方式暴露出去\n# --name=web 指定service名称，不指定默认和deployment的名称(这里是web)一致\n# --port=80 service的端口，k8s集群内部使用\n# --target-port=8080 容器应用的端口(这个应用是tomcat,一般默认是8080)\n# --type=NodePort nodeport类型会分配一个随机的端口给到集群外部访问\nkubectl expose --name=web deployment web --port=80 --target-port=8080 --type=NodePort \n\n# yaml文件方式暴露\n# --dry--run 不提交到集群，检查是否可运行\n# -o yaml 输出yaml文件格式\n# > web-sercice.yaml 输出重定向到名为web-service.yaml的文件\nkubectl expose --name=web deployment web --port=80 --target-port=8080 --type=NodePort --dry-run -o yaml > web-service.yaml\n\n# 查看所有service\nkubectl get service\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br")])]),n("h3",{attrs:{id:"_3-升级"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-升级"}},[s._v("#")]),s._v(" 3.升级")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("# 更新镜像版本\n# 滚动升级，原来有三个容器，升级后起三个新容器，每起好一个新容器就移除一个旧容器\nkubectl set image deployment/web nginx=nginx:1.15\n\n# 查看升级\nkubectl rollout status deployment/nginx-deployment\n\n# 在线编辑deployment,即时生效\nkubectl edit deployment/web\n\n# 在线编辑service,即时生效\nkubectl edit svc/web\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br")])]),n("h3",{attrs:{id:"_4-回滚"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-回滚"}},[s._v("#")]),s._v(" 4.回滚")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("# 查看该deployment的历史版本\nkubectl rollout history deployment/web\n\n# 回滚到上一个版本\n# 回滚也是滚动更新pod\nkubectl rollout undo deployment/web\n\n# 回滚到指定版本\nkubectl rollout undo deployment/web --revision=2\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br")])]),n("h3",{attrs:{id:"_5-删除"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-删除"}},[s._v("#")]),s._v(" 5.删除")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("# pod是根据deployment的定义来维持数量的，直接删除pod没有意义\n# 不想要某应用，应该删除deployment和svc\nkubectl delete deploy/web\nkubectl delete svc/web\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("h2",{attrs:{id:"弹性伸缩"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#弹性伸缩"}},[s._v("#")]),s._v(" 弹性伸缩")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("# 动态设定deployment的副本数，来增删应用实例数\n$ kubectl scale deployment nginx-deployment --replicas=10 \n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("h2",{attrs:{id:"replicas的作用"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#replicas的作用"}},[s._v("#")]),s._v(" replicas的作用")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("[root@k8s-master ~]# kubectl get deploy,rs\nNAME                              READY   UP-TO-DATE   AVAILABLE   AGE\ndeployment.extensions/java-demo   3/3     3            3           47h\ndeployment.extensions/nginx       1/1     1            1           3d14h\ndeployment.extensions/web         2/2     2            2           18h\n\nNAME                                         DESIRED   CURRENT   READY   AGE\nreplicaset.extensions/java-demo-75899cf7b5   3         3         3       47h\nreplicaset.extensions/nginx-554b9c67f9       1         1         1       3d14h\nreplicaset.extensions/web-789f47b5f          0         0         0       75s\nreplicaset.extensions/web-7dd67f8b9c         2         2         2       18h\n\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br")])]),n("p",[s._v("到现在我们应该能清楚，一个应用的运行，就是一个deployment的执行。而\n一个deployment每次执行都伴随着一个replicas的存在。replicas作为deployment\n的伴生产物，其主要有两个作用："),n("br")]),s._v(" "),n("p",[s._v("1.记录deployment的历史版本，回滚时需要从中指定版本或者回滚上一个。\n如上面的输出，web有两个replicas,其中一个就是历史版本。"),n("br")]),s._v(" "),n("p",[s._v("2.控制deployment的副本数,也就是pod的个数。比如一次版本更新，原先有三个副本，\n那么replicas会起一个新版本的副本pod-就绪状态,然后删除一个旧版本的副本。\n重复操作三次，直到副本数控制到3，且为新版本副本实例。service再把流量\n切换到这三个新副本上，此时副本实例的状态才变为Running。")])])}),[],!1,null,null,null);e.default=t.exports}}]);