(window.webpackJsonp=window.webpackJsonp||[]).push([[109],{465:function(e,n,a){"use strict";a.r(n);var s=a(42),t=Object(s.a)({},(function(){var e=this,n=e.$createElement,a=e._self._c||n;return a("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[a("h1",{attrs:{id:"rabbitmq进阶五之死信队列"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#rabbitmq进阶五之死信队列"}},[e._v("#")]),e._v(" RabbitMQ进阶五之死信队列")]),e._v(" "),a("hr"),e._v(" "),a("h2",{attrs:{id:"死信队列原理"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#死信队列原理"}},[e._v("#")]),e._v(" 死信队列原理")]),e._v(" "),a("p",[a("img",{attrs:{src:"/images/rabbitmq/queue-9.png",alt:""}}),a("br"),e._v("\n看图就差不多懂了。业务队列上绑定一个一个死信交换机。消息就可以由死信交换机路由到死信队列。"),a("br"),e._v("\n消息进入死信队列的前提是有队列绑定了死信交换机，并且死信交换机上绑定了队列。下面有几种消息进入死信队列的场景：")]),e._v(" "),a("ul",[a("li",[e._v("消息被消息者主动放弃，注意这里的主动放弃是指消息处理逻辑即使异常了，也不把消息重新放入业务队列。")]),e._v(" "),a("li",[e._v("消息在业务队列中设置了超时，超时不处理，消息也会进入死信队列")]),e._v(" "),a("li",[e._v("业务队列消息塞满了，新的消息无法进入业务队列。\n"),a("br"),e._v("\n下面我们就用代码模拟下这三种场景")])]),e._v(" "),a("h2",{attrs:{id:"准备"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#准备"}},[e._v("#")]),e._v(" 准备")]),e._v(" "),a("h3",{attrs:{id:"准备四个队列"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#准备四个队列"}},[e._v("#")]),e._v(" 准备四个队列")]),e._v(" "),a("ul",[a("li",[e._v("failQueue 用于存放通过死信交换机路由进来的消息，换句话说failQueue就是死信队列")]),e._v(" "),a("li",[e._v("handleQueue 用于测试处理业务逻辑出现异常被放弃的消息的业务消息队列")]),e._v(" "),a("li",[e._v("delayQueue 用于存放延迟消息的队列，这个队列没有消费者，为的就是看看消息超时是否会进入死信队列")]),e._v(" "),a("li",[e._v("lengthQueue 这是一个限制长度为3的消息队列，当继续投递第四条消息时，观察是否会有消息进入死信队列")]),e._v(" "),a("li",[e._v("注意我这里的队列都是非持久化队列，注意参数。为了重启后环境还原，这样测试方便。")])]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v('@Bean\npublic Queue failQueue(){\n    return new Queue(FAIL_QUEUE,false);\n}\n\n@Bean\npublic Queue delayQueue(){\n    Map<String, Object> args = new HashMap<>();\n    //x-dead-letter-exchange    这里声明当前队列绑定的死信交换机\n    args.put("x-dead-letter-exchange", ExchangeConfig.DEAD_LETTER_EXCHANGE);\n    //x-dead-letter-routing-key  这里声明当前队列的死信路由key\n    args.put("x-dead-letter-routing-key", BindingConfig.ROUTINGKEY_FAIL_NAME);\n    args.put("x-message-ttl",5000);\n    return new Queue(DELAY_QUEUE,false,false,false,args);\n}\n\n@Bean\npublic Queue handleQueue(){\n    Map<String, Object> args = new HashMap<>();\n    //x-dead-letter-exchange    这里声明当前队列绑定的死信交换机\n    args.put("x-dead-letter-exchange", ExchangeConfig.DEAD_LETTER_EXCHANGE);\n    //x-dead-letter-routing-key  这里声明当前队列的死信路由key\n    args.put("x-dead-letter-routing-key", BindingConfig.ROUTINGKEY_FAIL_NAME);\n    return new Queue(HANDLE_QUEUE,false,false,false,args);\n}\n\n@Bean\npublic Queue lengthQueue(){\n    Map<String, Object> args = new HashMap<>();\n    //x-dead-letter-exchange    这里声明当前队列绑定的死信交换机\n    args.put("x-dead-letter-exchange", ExchangeConfig.DEAD_LETTER_EXCHANGE);\n    //x-dead-letter-routing-key  这里声明当前队列的死信路由key\n    args.put("x-dead-letter-routing-key", BindingConfig.ROUTINGKEY_FAIL_NAME);\n    args.put("x-max-length",3);\n    return new Queue(LENGTH_QUEUE,false,false,false,args);\n}\n')])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br"),a("span",{staticClass:"line-number"},[e._v("4")]),a("br"),a("span",{staticClass:"line-number"},[e._v("5")]),a("br"),a("span",{staticClass:"line-number"},[e._v("6")]),a("br"),a("span",{staticClass:"line-number"},[e._v("7")]),a("br"),a("span",{staticClass:"line-number"},[e._v("8")]),a("br"),a("span",{staticClass:"line-number"},[e._v("9")]),a("br"),a("span",{staticClass:"line-number"},[e._v("10")]),a("br"),a("span",{staticClass:"line-number"},[e._v("11")]),a("br"),a("span",{staticClass:"line-number"},[e._v("12")]),a("br"),a("span",{staticClass:"line-number"},[e._v("13")]),a("br"),a("span",{staticClass:"line-number"},[e._v("14")]),a("br"),a("span",{staticClass:"line-number"},[e._v("15")]),a("br"),a("span",{staticClass:"line-number"},[e._v("16")]),a("br"),a("span",{staticClass:"line-number"},[e._v("17")]),a("br"),a("span",{staticClass:"line-number"},[e._v("18")]),a("br"),a("span",{staticClass:"line-number"},[e._v("19")]),a("br"),a("span",{staticClass:"line-number"},[e._v("20")]),a("br"),a("span",{staticClass:"line-number"},[e._v("21")]),a("br"),a("span",{staticClass:"line-number"},[e._v("22")]),a("br"),a("span",{staticClass:"line-number"},[e._v("23")]),a("br"),a("span",{staticClass:"line-number"},[e._v("24")]),a("br"),a("span",{staticClass:"line-number"},[e._v("25")]),a("br"),a("span",{staticClass:"line-number"},[e._v("26")]),a("br"),a("span",{staticClass:"line-number"},[e._v("27")]),a("br"),a("span",{staticClass:"line-number"},[e._v("28")]),a("br"),a("span",{staticClass:"line-number"},[e._v("29")]),a("br"),a("span",{staticClass:"line-number"},[e._v("30")]),a("br"),a("span",{staticClass:"line-number"},[e._v("31")]),a("br"),a("span",{staticClass:"line-number"},[e._v("32")]),a("br"),a("span",{staticClass:"line-number"},[e._v("33")]),a("br"),a("span",{staticClass:"line-number"},[e._v("34")]),a("br"),a("span",{staticClass:"line-number"},[e._v("35")]),a("br"),a("span",{staticClass:"line-number"},[e._v("36")]),a("br")])]),a("h3",{attrs:{id:"配置交换机"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#配置交换机"}},[e._v("#")]),e._v(" 配置交换机")]),e._v(" "),a("ul",[a("li",[e._v("两个都是topic类型的交换机，但是扮演的角色不同")])]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("@Bean\npublic TopicExchange topicExchange() {\n    return new TopicExchange(TOPIC_EXCHANGE);\n}\n\n@Bean\npublic TopicExchange deadLetterExchange() {\n    return new TopicExchange(DEAD_LETTER_EXCHANGE);\n}\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br"),a("span",{staticClass:"line-number"},[e._v("4")]),a("br"),a("span",{staticClass:"line-number"},[e._v("5")]),a("br"),a("span",{staticClass:"line-number"},[e._v("6")]),a("br"),a("span",{staticClass:"line-number"},[e._v("7")]),a("br"),a("span",{staticClass:"line-number"},[e._v("8")]),a("br"),a("span",{staticClass:"line-number"},[e._v("9")]),a("br")])]),a("h3",{attrs:{id:"配置绑定关系"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#配置绑定关系"}},[e._v("#")]),e._v(" 配置绑定关系")]),e._v(" "),a("ul",[a("li",[e._v("failQueue 绑定在死信交换机 deadLetterExchange 上，路由：failKey")]),e._v(" "),a("li",[e._v("handleQueue绑定在死信交换机 topicExchange 上，路由：handleKey")]),e._v(" "),a("li",[e._v("delayQueue绑定在死信交换机 topicExchange 上，路由：delayKey")]),e._v(" "),a("li",[e._v("lengthQueue绑定在死信交换机 topicExchange 上，路由：lengthKey")])]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("@Bean\npublic Binding delayBinding(TopicExchange topicExchange, Queue delayQueue) {\n    return BindingBuilder.bind(delayQueue).to(topicExchange).with(ROUTINGKEY_DELAY_NAME);\n}\n\n@Bean\npublic Binding failBinding(TopicExchange deadLetterExchange, Queue failQueue) {\n    return BindingBuilder.bind(failQueue).to(deadLetterExchange).with(ROUTINGKEY_FAIL_NAME);\n}\n\n@Bean\npublic Binding handleBinding(TopicExchange topicExchange, Queue handleQueue) {\n    return BindingBuilder.bind(handleQueue).to(topicExchange).with(ROUTINGKEY_HANDLE_NAME);\n}\n\n@Bean\npublic Binding lengthBinding(TopicExchange topicExchange, Queue lengthQueue) {\n    return BindingBuilder.bind(lengthQueue).to(topicExchange).with(ROUTINGKEY_LENGTH_NAME);\n}\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br"),a("span",{staticClass:"line-number"},[e._v("4")]),a("br"),a("span",{staticClass:"line-number"},[e._v("5")]),a("br"),a("span",{staticClass:"line-number"},[e._v("6")]),a("br"),a("span",{staticClass:"line-number"},[e._v("7")]),a("br"),a("span",{staticClass:"line-number"},[e._v("8")]),a("br"),a("span",{staticClass:"line-number"},[e._v("9")]),a("br"),a("span",{staticClass:"line-number"},[e._v("10")]),a("br"),a("span",{staticClass:"line-number"},[e._v("11")]),a("br"),a("span",{staticClass:"line-number"},[e._v("12")]),a("br"),a("span",{staticClass:"line-number"},[e._v("13")]),a("br"),a("span",{staticClass:"line-number"},[e._v("14")]),a("br"),a("span",{staticClass:"line-number"},[e._v("15")]),a("br"),a("span",{staticClass:"line-number"},[e._v("16")]),a("br"),a("span",{staticClass:"line-number"},[e._v("17")]),a("br"),a("span",{staticClass:"line-number"},[e._v("18")]),a("br"),a("span",{staticClass:"line-number"},[e._v("19")]),a("br")])]),a("h3",{attrs:{id:"注意配置文件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#注意配置文件"}},[e._v("#")]),e._v(" 注意配置文件")]),e._v(" "),a("p",[e._v("我是关闭了手动应答来测试的，如果你有其他目的，请自行修改响应的消费者代码逻辑。")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("# 消费者配置\nlistener:\n  simple:\n    # 最多只允许一条未确认\n    prefetch: 1\n    # 开启手动应答\n#    acknowledge-mode: manual\n#    default-requeue-rejected: false\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br"),a("span",{staticClass:"line-number"},[e._v("4")]),a("br"),a("span",{staticClass:"line-number"},[e._v("5")]),a("br"),a("span",{staticClass:"line-number"},[e._v("6")]),a("br"),a("span",{staticClass:"line-number"},[e._v("7")]),a("br"),a("span",{staticClass:"line-number"},[e._v("8")]),a("br")])]),a("h3",{attrs:{id:"准备消息生成方"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#准备消息生成方"}},[e._v("#")]),e._v(" 准备消息生成方")]),e._v(" "),a("p",[e._v("这个没什么特别的，也别整事务或者确认机制，我们只测死信，其他的能简则简。")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v('1.投递消息到 handleQueue\npublic boolean sendToHandleQueue(String msg){\n    rabbitTemplate.convertAndSend(topicExchange.getName(), BindingConfig.ROUTINGKEY_HANDLE_NAME,msg);\n    System.out.println(msg+" : 发送时间 => "+System.currentTimeMillis());\n    return true;\n}\n\n2.投递下次到 delayQueue\npublic boolean sendDelayQueue(String msg){\n    rabbitTemplate.convertAndSend(topicExchange.getName(), BindingConfig.ROUTINGKEY_DELAY_NAME,msg);\n    System.out.println(msg+" : 发送时间 => "+ LocalDateTime.now());\n    return true;\n}\n\n3.投递消息到 lengthQueue\npublic boolean sendLengthQueue(String msg){\n    rabbitTemplate.convertAndSend(topicExchange.getName(), BindingConfig.ROUTINGKEY_LENGTH_NAME,msg);\n    System.out.println(msg+" : 发送时间 => "+ LocalDateTime.now());\n    return true;\n}\n')])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br"),a("span",{staticClass:"line-number"},[e._v("4")]),a("br"),a("span",{staticClass:"line-number"},[e._v("5")]),a("br"),a("span",{staticClass:"line-number"},[e._v("6")]),a("br"),a("span",{staticClass:"line-number"},[e._v("7")]),a("br"),a("span",{staticClass:"line-number"},[e._v("8")]),a("br"),a("span",{staticClass:"line-number"},[e._v("9")]),a("br"),a("span",{staticClass:"line-number"},[e._v("10")]),a("br"),a("span",{staticClass:"line-number"},[e._v("11")]),a("br"),a("span",{staticClass:"line-number"},[e._v("12")]),a("br"),a("span",{staticClass:"line-number"},[e._v("13")]),a("br"),a("span",{staticClass:"line-number"},[e._v("14")]),a("br"),a("span",{staticClass:"line-number"},[e._v("15")]),a("br"),a("span",{staticClass:"line-number"},[e._v("16")]),a("br"),a("span",{staticClass:"line-number"},[e._v("17")]),a("br"),a("span",{staticClass:"line-number"},[e._v("18")]),a("br"),a("span",{staticClass:"line-number"},[e._v("19")]),a("br"),a("span",{staticClass:"line-number"},[e._v("20")]),a("br")])]),a("h2",{attrs:{id:"测试整起来"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#测试整起来"}},[e._v("#")]),e._v(" 测试整起来")]),e._v(" "),a("h3",{attrs:{id:"测试业务异常丢弃消息"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#测试业务异常丢弃消息"}},[e._v("#")]),e._v(" 测试业务异常丢弃消息")]),e._v(" "),a("p",[e._v("1.先上业务消息消费处理代码")]),e._v(" "),a("ul",[a("li",[e._v("主要查看channel.basicNack()这行代码，第三个参数是消息不重新入队的意思，即丢弃这条消息。")]),e._v(" "),a("li",[e._v("在消息中留下一个标记，控制异常产生。模拟消息丢弃场景。")])]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v('@RabbitListener(queues = QueueConfig.HANDLE_QUEUE)\npublic void receive(Message message, Channel channel) throws IOException {\n    String msg = new String(message.getBody());\n    System.out.println("[死信队列]测试 => " + msg);\n    int flag = Integer.parseInt(msg.split("-")[1]);\n    try {\n        Thread.sleep(1000);\n        int x = 5 / flag;\n    } catch (Exception e) {\n        channel.basicNack(message.getMessageProperties().getDeliveryTag(), false, false);\n        throw new RuntimeException(e.getMessage());\n    }\n}\n')])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br"),a("span",{staticClass:"line-number"},[e._v("4")]),a("br"),a("span",{staticClass:"line-number"},[e._v("5")]),a("br"),a("span",{staticClass:"line-number"},[e._v("6")]),a("br"),a("span",{staticClass:"line-number"},[e._v("7")]),a("br"),a("span",{staticClass:"line-number"},[e._v("8")]),a("br"),a("span",{staticClass:"line-number"},[e._v("9")]),a("br"),a("span",{staticClass:"line-number"},[e._v("10")]),a("br"),a("span",{staticClass:"line-number"},[e._v("11")]),a("br"),a("span",{staticClass:"line-number"},[e._v("12")]),a("br"),a("span",{staticClass:"line-number"},[e._v("13")]),a("br")])]),a("p",[e._v("2.看结果\n控制消息触发异常，并放弃消息。果然符合预期，消息通过死信交换机进入到了死信队列。")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("[死信队列]测试 => 新消息874-0\nCaused by: java.lang.RuntimeException: / by zero\n\tat com.david.consumer.DeadLetterReceiver.receive(DeadLetterReceiver.java:25) ~[classes/:na]\n\tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method) ~[na:1.8.0_91]\n\tat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62) ~[na:1.8.0_91]\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43) ~[na:1.8.0_91]\n\tat java.lang.reflect.Method.invoke(Method.java:498) ~[na:1.8.0_91]\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br"),a("span",{staticClass:"line-number"},[e._v("4")]),a("br"),a("span",{staticClass:"line-number"},[e._v("5")]),a("br"),a("span",{staticClass:"line-number"},[e._v("6")]),a("br"),a("span",{staticClass:"line-number"},[e._v("7")]),a("br")])]),a("p",[a("img",{attrs:{src:"/images/rabbitmq/queue-10.png",alt:""}}),a("br")]),e._v(" "),a("h3",{attrs:{id:"测试超时不消费的消息"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#测试超时不消费的消息"}},[e._v("#")]),e._v(" 测试超时不消费的消息")]),e._v(" "),a("p",[e._v("模拟超时不消费，只需要不给该队列配置消费者监听器就可以了，时间到了就自然会进入死信队列。不过为了让我们更清楚的知道，这个消息真的是超时了。\n我们来给死信队列配置一个消费者监听器。比如上面设置的延迟5s，我们通过发送消息时间和死信队列消费的时间，来验证超时。"),a("br"),e._v("\n1.先上监听器")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v('@RabbitListener(queues = QueueConfig.FAIL_QUEUE)\npublic void receiveFail(String msg) throws IOException {\n    System.out.println("[失败队列消费监听] => " + msg + " : " + LocalDateTime.now());\n}\n')])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br"),a("span",{staticClass:"line-number"},[e._v("4")]),a("br")])]),a("p",[e._v("2.往delayQueue里面投递消息")]),e._v(" "),a("ul",[a("li",[e._v("还好我手速够快，在5s内抓拍到了消息在delayQueue存在过的证据。因为Rabbitmq后台刷新有延迟，我设置的5s,所以你看的有延迟。不过没关系，看打印\n结果。往delayQueue投递的时间，和failQueue消费掉的时间相差就是5s多一点点，消息流经各种渠道肯定有时间损耗的啦。不过也符合我们的预期了。\n"),a("img",{attrs:{src:"/images/rabbitmq/queue-11.png",alt:""}}),a("br")])]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("新消息697 : 发送时间 => 2020-04-22T17:11:45.547\n[失败队列消费监听] => 新消息697 : 2020-04-22T17:11:50.570\n\n新消息602 : 发送时间 => 2020-04-22T17:17:19.596\n新消息469 : 发送时间 => 2020-04-22T17:17:21.614\n[失败队列消费监听] => 新消息602 : 2020-04-22T17:17:24.619\n[失败队列消费监听] => 新消息469 : 2020-04-22T17:17:26.636\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br"),a("span",{staticClass:"line-number"},[e._v("4")]),a("br"),a("span",{staticClass:"line-number"},[e._v("5")]),a("br"),a("span",{staticClass:"line-number"},[e._v("6")]),a("br"),a("span",{staticClass:"line-number"},[e._v("7")]),a("br")])]),a("h3",{attrs:{id:"测试队列已满"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#测试队列已满"}},[e._v("#")]),e._v(" 测试队列已满")]),e._v(" "),a("ul",[a("li",[e._v("1.上面队列配置，我们配置了容量为3的队列lengthQueue。当投递第四条消息时,到底是第4条消息进入死信队列，还是前三条的哪一条呢？")]),e._v(" "),a("li",[e._v("2.保持死信队列消费者监听器，当触发消息进入死信队列时，我们就很容易知道，是哪条消息被推进了死信交换机。")]),e._v(" "),a("li",[e._v("3.无须修改代码直接测试，往lengthQueue投递4条带有序号的消息\n"),a("img",{attrs:{src:"/images/rabbitmq/queue-12.png",alt:""}}),a("br")])]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("新消息664-1 : 发送时间 => 2020-04-22T17:24:28.286\n新消息282-2 : 发送时间 => 2020-04-22T17:24:33.078\n新消息36-3 : 发送时间 => 2020-04-22T17:24:37.288\n新消息197-4 : 发送时间 => 2020-04-22T17:24:42.789\n[失败队列消费监听] => 新消息664-1 : 2020-04-22T17:24:42.802\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br"),a("span",{staticClass:"line-number"},[e._v("4")]),a("br"),a("span",{staticClass:"line-number"},[e._v("5")]),a("br")])]),a("p",[e._v("由上面的截图和打印可知，lengthQueue信守了承诺，只保存三条信息，而被死信交换机路由到死信队列的消息是序号为1的那条。这可以得出，当队列满了，\n继续投递消息，会把队头的消息移出到死信队列。")])])}),[],!1,null,null,null);n.default=t.exports}}]);