(window.webpackJsonp=window.webpackJsonp||[]).push([[108],{458:function(n,a,s){"use strict";s.r(a);var t=s(42),e=Object(t.a)({},(function(){var n=this,a=n.$createElement,s=n._self._c||a;return s("ContentSlotsDistributor",{attrs:{"slot-key":n.$parent.slotKey}},[s("h1",{attrs:{id:"rabbitmq进阶二之提交成功-事务"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#rabbitmq进阶二之提交成功-事务"}},[n._v("#")]),n._v(" RabbitMQ进阶二之提交成功-事务")]),n._v(" "),s("hr"),n._v(" "),s("h2",{attrs:{id:"确保消息正确提交到服务器"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#确保消息正确提交到服务器"}},[n._v("#")]),n._v(" 确保消息正确提交到服务器")]),n._v(" "),s("p",[n._v("确保消息准确提交到服务器，有三种方式。本篇我们先尝试使用事务的方式提交消息。")]),n._v(" "),s("ul",[s("li",[n._v("类似数据库事务，发送前开启事务")]),n._v(" "),s("li",[n._v("发送成功就提交事务，消息就可以保证是提交到服务器")]),n._v(" "),s("li",[n._v("捕捉全部异常，如果发生异常就回滚事务，就可以知道该消息没有提交过去")])]),n._v(" "),s("h2",{attrs:{id:"以事务方式确保消息投递的状态"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#以事务方式确保消息投递的状态"}},[n._v("#")]),n._v(" 以事务方式确保消息投递的状态")]),n._v(" "),s("h3",{attrs:{id:"准备测试队列"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#准备测试队列"}},[n._v("#")]),n._v(" 准备测试队列")]),n._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[n._v("@Bean\npublic Queue transactionQueue(){\n    return new Queue(TRANSACTION_QUEUE);\n}\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br")])]),s("h3",{attrs:{id:"以事务的方式投递代码实现"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#以事务的方式投递代码实现"}},[n._v("#")]),n._v(" 以事务的方式投递代码实现")]),n._v(" "),s("p",[n._v("没什么多说的，直接上注释。其中有一个integer类型的参数，用作产生异常触发事务回滚。")]),n._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[n._v("/**\n * 以事务模型提交消息\n * 1.获取链接工厂\n * 2.开启连接\n * 3.建立信道(true)\n * 4.开启事务（本方法中已经在建立信道时开启了事务）\n */\npublic boolean sendWithTransaction(String msg,int flag) throws IOException, TimeoutException {\n    //获取连接工厂\n    ConnectionFactory connectionFactory = rabbitTemplate.getConnectionFactory();\n\n    //开启连接 - tcp连接\n    Connection connection = connectionFactory.createConnection();\n\n    // 建立信道 构造参数 true代表该信道开启 Transactional 事务模式\n    // true - createChannel()方法内部已经调用了channel.txSelect()\n    Channel channel = connection.createChannel(true);\n\n    try {\n        channel.basicPublish(topicExchange.getName(), BindingConfig.ROUTINGKEY_Transaction_NAME, true,\n                MessageProperties.PERSISTENT_BASIC, msg.getBytes());\n        int x = 5 / flag;\n        channel.txCommit();\n        return true;\n    } catch (Exception e) {\n        channel.txRollback();\n        e.printStackTrace();\n    } finally {\n        channel.close();\n        connection.close();\n    }\n    return false;\n}\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br"),s("span",{staticClass:"line-number"},[n._v("8")]),s("br"),s("span",{staticClass:"line-number"},[n._v("9")]),s("br"),s("span",{staticClass:"line-number"},[n._v("10")]),s("br"),s("span",{staticClass:"line-number"},[n._v("11")]),s("br"),s("span",{staticClass:"line-number"},[n._v("12")]),s("br"),s("span",{staticClass:"line-number"},[n._v("13")]),s("br"),s("span",{staticClass:"line-number"},[n._v("14")]),s("br"),s("span",{staticClass:"line-number"},[n._v("15")]),s("br"),s("span",{staticClass:"line-number"},[n._v("16")]),s("br"),s("span",{staticClass:"line-number"},[n._v("17")]),s("br"),s("span",{staticClass:"line-number"},[n._v("18")]),s("br"),s("span",{staticClass:"line-number"},[n._v("19")]),s("br"),s("span",{staticClass:"line-number"},[n._v("20")]),s("br"),s("span",{staticClass:"line-number"},[n._v("21")]),s("br"),s("span",{staticClass:"line-number"},[n._v("22")]),s("br"),s("span",{staticClass:"line-number"},[n._v("23")]),s("br"),s("span",{staticClass:"line-number"},[n._v("24")]),s("br"),s("span",{staticClass:"line-number"},[n._v("25")]),s("br"),s("span",{staticClass:"line-number"},[n._v("26")]),s("br"),s("span",{staticClass:"line-number"},[n._v("27")]),s("br"),s("span",{staticClass:"line-number"},[n._v("28")]),s("br"),s("span",{staticClass:"line-number"},[n._v("29")]),s("br"),s("span",{staticClass:"line-number"},[n._v("30")]),s("br"),s("span",{staticClass:"line-number"},[n._v("31")]),s("br"),s("span",{staticClass:"line-number"},[n._v("32")]),s("br"),s("span",{staticClass:"line-number"},[n._v("33")]),s("br")])]),s("h3",{attrs:{id:"测试无异常消息提交"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#测试无异常消息提交"}},[n._v("#")]),n._v(" 测试无异常消息提交")]),n._v(" "),s("p",[n._v("只要flag不为零，就不会有异常，消息可以正常提交到服务器。\n"),s("img",{attrs:{src:"/images/rabbitmq/queue-4.png",alt:""}}),s("br")]),n._v(" "),s("h3",{attrs:{id:"测试有异常消息提交"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#测试有异常消息提交"}},[n._v("#")]),n._v(" 测试有异常消息提交")]),n._v(" "),s("p",[n._v("这次我们让flag为0，产生异常。我们是在发送消息动作完成后，提交事务前触发异常。如果事务\n正常工作，那么消息数量应该还是保持在之前提交的1条。\n"),s("img",{attrs:{src:"/images/rabbitmq/queue-5.png",alt:""}}),s("br"),n._v(" "),s("img",{attrs:{src:"/images/rabbitmq/queue-6.png",alt:""}}),s("br"),n._v("\n如上图，异常抛出，在捕捉异常的catch里面，我们回滚了事务，消息没有提交到服务器。尽然已经确定了\n消息没有投递到服务器，我们可以选择休眠一秒后继续提交，然后尝试三次后还是不成功。那么可以\n触发一些风险报警机制了。具体怎么做那就看自己的选择了。")])])}),[],!1,null,null,null);a.default=e.exports}}]);