(window.webpackJsonp=window.webpackJsonp||[]).push([[107],{461:function(n,s,a){"use strict";a.r(s);var e=a(42),t=Object(e.a)({},(function(){var n=this,s=n.$createElement,a=n._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":n.$parent.slotKey}},[a("h1",{attrs:{id:"rabbitmq进阶三之提交成功-confirm"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#rabbitmq进阶三之提交成功-confirm"}},[n._v("#")]),n._v(" RabbitMQ进阶三之提交成功-confirm")]),n._v(" "),a("hr"),n._v(" "),a("h2",{attrs:{id:"confirm模式消息提交"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#confirm模式消息提交"}},[n._v("#")]),n._v(" confirm模式消息提交")]),n._v(" "),a("p",[n._v("在上一篇事务消息提交中，我们基本完成了消息投递中的状态掌控。但是事务毕竟是个高消耗操作，当\n大量消息通过事务模型去投递，那会大大降低消息并发投递的数量。有没有更好的一点方式呢？有的。\n这就是我们要提到的确认模式。分同步确认和异步确认。这一说，大家就很明白，异步确认才是最优解。\n何为确认？当消息投递到服务器，那么在消息抵达到队列中，并保存下来，才会返回确认的机制。")]),n._v(" "),a("h2",{attrs:{id:"创建确认消息队列"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#创建确认消息队列"}},[n._v("#")]),n._v(" 创建确认消息队列")]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v("@Bean\npublic Queue confirmQueue() {\n    return new Queue(CONFIRM_QUEUE);\n}\n")])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br"),a("span",{staticClass:"line-number"},[n._v("2")]),a("br"),a("span",{staticClass:"line-number"},[n._v("3")]),a("br"),a("span",{staticClass:"line-number"},[n._v("4")]),a("br")])]),a("h2",{attrs:{id:"消息投递之同步确认"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#消息投递之同步确认"}},[n._v("#")]),n._v(" 消息投递之同步确认")]),n._v(" "),a("h3",{attrs:{id:"消息投递实现"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#消息投递实现"}},[n._v("#")]),n._v(" 消息投递实现")]),n._v(" "),a("p",[n._v("注意确认模式下就不要开启事务了。其他的直接看注释吧。")]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v("/**\n * 1.获取链接工厂\n * 2.开启连接\n * 3.建立信道(false)\n * 4.开启发布确认模式\n **/\npublic boolean sendWithSyncConfirm(String msg) throws IOException, TimeoutException {\n    //获取连接工厂\n    ConnectionFactory connectionFactory = rabbitTemplate.getConnectionFactory();\n\n    //开启连接 - tcp连接\n    Connection connection = connectionFactory.createConnection();\n\n    // 建立信道\n    // false - 不开启事务\n    Channel channel = connection.createChannel(false);\n\n    try {\n        //开启发布确认模式\n        channel.confirmSelect();\n        channel.basicPublish(topicExchange.getName(), BindingConfig.ROUTINGKEY_CONFIRM_NAME,true,\n                MessageProperties.PERSISTENT_BASIC,msg.getBytes());\n        return channel.waitForConfirms();\n    }catch (Exception e){\n        e.printStackTrace();\n    }finally {\n        channel.close();\n        connection.close();\n    }\n    return false;\n}\n\n")])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br"),a("span",{staticClass:"line-number"},[n._v("2")]),a("br"),a("span",{staticClass:"line-number"},[n._v("3")]),a("br"),a("span",{staticClass:"line-number"},[n._v("4")]),a("br"),a("span",{staticClass:"line-number"},[n._v("5")]),a("br"),a("span",{staticClass:"line-number"},[n._v("6")]),a("br"),a("span",{staticClass:"line-number"},[n._v("7")]),a("br"),a("span",{staticClass:"line-number"},[n._v("8")]),a("br"),a("span",{staticClass:"line-number"},[n._v("9")]),a("br"),a("span",{staticClass:"line-number"},[n._v("10")]),a("br"),a("span",{staticClass:"line-number"},[n._v("11")]),a("br"),a("span",{staticClass:"line-number"},[n._v("12")]),a("br"),a("span",{staticClass:"line-number"},[n._v("13")]),a("br"),a("span",{staticClass:"line-number"},[n._v("14")]),a("br"),a("span",{staticClass:"line-number"},[n._v("15")]),a("br"),a("span",{staticClass:"line-number"},[n._v("16")]),a("br"),a("span",{staticClass:"line-number"},[n._v("17")]),a("br"),a("span",{staticClass:"line-number"},[n._v("18")]),a("br"),a("span",{staticClass:"line-number"},[n._v("19")]),a("br"),a("span",{staticClass:"line-number"},[n._v("20")]),a("br"),a("span",{staticClass:"line-number"},[n._v("21")]),a("br"),a("span",{staticClass:"line-number"},[n._v("22")]),a("br"),a("span",{staticClass:"line-number"},[n._v("23")]),a("br"),a("span",{staticClass:"line-number"},[n._v("24")]),a("br"),a("span",{staticClass:"line-number"},[n._v("25")]),a("br"),a("span",{staticClass:"line-number"},[n._v("26")]),a("br"),a("span",{staticClass:"line-number"},[n._v("27")]),a("br"),a("span",{staticClass:"line-number"},[n._v("28")]),a("br"),a("span",{staticClass:"line-number"},[n._v("29")]),a("br"),a("span",{staticClass:"line-number"},[n._v("30")]),a("br"),a("span",{staticClass:"line-number"},[n._v("31")]),a("br"),a("span",{staticClass:"line-number"},[n._v("32")]),a("br")])]),a("h3",{attrs:{id:"消息测试"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#消息测试"}},[n._v("#")]),n._v(" 消息测试")]),n._v(" "),a("p",[n._v("同样的先测试一条正常，然后再发送一条产生异常的消息。")]),n._v(" "),a("div",{staticClass:"custom-block warning"},[a("p",{staticClass:"custom-block-title"},[n._v("WARNING")]),n._v(" "),a("p",[n._v("同步测试消息投递到交换机但是没有到Queue,返回正常。这个不符合期望的结果，先留着......")])]),n._v(" "),a("h2",{attrs:{id:"消息投递之异步确认"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#消息投递之异步确认"}},[n._v("#")]),n._v(" 消息投递之异步确认")]),n._v(" "),a("h3",{attrs:{id:"消息投递确认"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#消息投递确认"}},[n._v("#")]),n._v(" 消息投递确认")]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v('/**\n * 异步应答\n **/\npublic void sendWithAsyncConfirm(String msg) {\n    //获取回调\n    rabbitTemplate.setReturnCallback((Message message, int replyCode, String replyText, String exchange, String routingKey) -> {\n        String correlationId = message.getMessageProperties().getHeaders().get("spring_returned_message_correlation").toString();\n        String oriMsg = new String(message.getBody());\n        System.out.println("消息ID: " + correlationId + "\\n"\n                + "消息: " + message + "\\n"\n                + "应答码: " + replyCode + "\\n"\n                + "原因: " + replyText + "\\n"\n                + "交换机: " + exchange + "\\n"\n                + "路由键: " + routingKey + "\\n"\n                + "原消息: " + oriMsg + "\\n");\n    });\n\n    // 获取异步确认\n    rabbitTemplate.setConfirmCallback((CorrelationData correlationData, boolean ack, String cause) -> {\n        if (ack) {\n            System.out.println("消息id为: " + correlationData + "的消息，已经被ack成功");\n        } else {\n            System.out.println("消息id为: " + correlationData + "的消息，消息nack，失败原因是：" + cause);\n        }\n    });\n\n    //发送消息\n    rabbitTemplate.convertAndSend(topicExchange.getName(), BindingConfig.ROUTINGKEY_CONFIRM_NAME, msg,\n            new CorrelationData(UUID.randomUUID().toString().replace("-", "")));\n}\n')])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br"),a("span",{staticClass:"line-number"},[n._v("2")]),a("br"),a("span",{staticClass:"line-number"},[n._v("3")]),a("br"),a("span",{staticClass:"line-number"},[n._v("4")]),a("br"),a("span",{staticClass:"line-number"},[n._v("5")]),a("br"),a("span",{staticClass:"line-number"},[n._v("6")]),a("br"),a("span",{staticClass:"line-number"},[n._v("7")]),a("br"),a("span",{staticClass:"line-number"},[n._v("8")]),a("br"),a("span",{staticClass:"line-number"},[n._v("9")]),a("br"),a("span",{staticClass:"line-number"},[n._v("10")]),a("br"),a("span",{staticClass:"line-number"},[n._v("11")]),a("br"),a("span",{staticClass:"line-number"},[n._v("12")]),a("br"),a("span",{staticClass:"line-number"},[n._v("13")]),a("br"),a("span",{staticClass:"line-number"},[n._v("14")]),a("br"),a("span",{staticClass:"line-number"},[n._v("15")]),a("br"),a("span",{staticClass:"line-number"},[n._v("16")]),a("br"),a("span",{staticClass:"line-number"},[n._v("17")]),a("br"),a("span",{staticClass:"line-number"},[n._v("18")]),a("br"),a("span",{staticClass:"line-number"},[n._v("19")]),a("br"),a("span",{staticClass:"line-number"},[n._v("20")]),a("br"),a("span",{staticClass:"line-number"},[n._v("21")]),a("br"),a("span",{staticClass:"line-number"},[n._v("22")]),a("br"),a("span",{staticClass:"line-number"},[n._v("23")]),a("br"),a("span",{staticClass:"line-number"},[n._v("24")]),a("br"),a("span",{staticClass:"line-number"},[n._v("25")]),a("br"),a("span",{staticClass:"line-number"},[n._v("26")]),a("br"),a("span",{staticClass:"line-number"},[n._v("27")]),a("br"),a("span",{staticClass:"line-number"},[n._v("28")]),a("br"),a("span",{staticClass:"line-number"},[n._v("29")]),a("br"),a("span",{staticClass:"line-number"},[n._v("30")]),a("br")])]),a("h3",{attrs:{id:"配置文件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#配置文件"}},[n._v("#")]),n._v(" 配置文件")]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v("# 跟在spring.rabbitmq后面\n# 生产者异步确认配置参数\ntemplate:\n  # 开启投递错误，消息强制返回给生产者端\n  mandatory: true\n# 开启消息发布回调\npublisher-returns: true\n# 开启消息发布确认类型\npublisher-confirm-type: simple\n\n")])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br"),a("span",{staticClass:"line-number"},[n._v("2")]),a("br"),a("span",{staticClass:"line-number"},[n._v("3")]),a("br"),a("span",{staticClass:"line-number"},[n._v("4")]),a("br"),a("span",{staticClass:"line-number"},[n._v("5")]),a("br"),a("span",{staticClass:"line-number"},[n._v("6")]),a("br"),a("span",{staticClass:"line-number"},[n._v("7")]),a("br"),a("span",{staticClass:"line-number"},[n._v("8")]),a("br"),a("span",{staticClass:"line-number"},[n._v("9")]),a("br"),a("span",{staticClass:"line-number"},[n._v("10")]),a("br")])]),a("h3",{attrs:{id:"测试"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#测试"}},[n._v("#")]),n._v(" 测试")]),n._v(" "),a("p",[n._v("启动后，直接接触交换机和队列之间的路由key绑定。按照计划，这时发送消息，消息由于找不到合适队列去存放消息，消息将被回退，监听器异步ACK\n监听到false."),a("br"),n._v("\n这里我解绑交换机和队列后，测试异步消息确认。看下面的日志输出，虽然接触了绑定，但是消息还是抵达了交换机，那么ack就是true.而由于没有合适\n的路由将消息引向合适的队列，就触发了方法回调，消息被退回。原因也打印了出来，就是没有路由key.")]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v("消息ID: 850f31ef01024ca8b14d0d060375934d\n消息: (Body:'新消息662' MessageProperties [headers={spring_returned_message_correlation=850f31ef01024ca8b14d0d060375934d}, contentType=text/plain, contentEncoding=UTF-8, contentLength=0, receivedDeliveryMode=PERSISTENT, priority=0, deliveryTag=0])\n应答码: 312\n原因: NO_ROUTE\n交换机: topicExchange\n路由键: confirmKey\n原消息: 新消息662\n\n消息id为: CorrelationData [id=850f31ef01024ca8b14d0d060375934d]的消息，已经被ack成功null\n")])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br"),a("span",{staticClass:"line-number"},[n._v("2")]),a("br"),a("span",{staticClass:"line-number"},[n._v("3")]),a("br"),a("span",{staticClass:"line-number"},[n._v("4")]),a("br"),a("span",{staticClass:"line-number"},[n._v("5")]),a("br"),a("span",{staticClass:"line-number"},[n._v("6")]),a("br"),a("span",{staticClass:"line-number"},[n._v("7")]),a("br"),a("span",{staticClass:"line-number"},[n._v("8")]),a("br"),a("span",{staticClass:"line-number"},[n._v("9")]),a("br")])])])}),[],!1,null,null,null);s.default=t.exports}}]);